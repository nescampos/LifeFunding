@model LifeFunding.Web.Models.Database.Cause

@{
    ViewBag.Title = "ViewCause";
}


<script type="text/javascript">
    var server = new StellarSdk.Server('https://horizon-testnet.stellar.org');
    var balance = 0;

    $(function () {
        server.loadAccount(
            '@Model.StellarAddress'
        ).then((account) => {
            balance = Number.parseFloat(account.balances.find(b => b.asset_type == 'native').balance);
            $('#balance').text(balance);
        });
    });

    function donate() {
        try {
            var keypair = StellarSdk.Keypair.fromSecret($('#secret').val())
            this.server
                .loadAccount(keypair.publicKey())
                .then((account) => {
                    const transaction = new StellarSdk.TransactionBuilder(account, {
                        fee: StellarSdk.BASE_FEE,
                        networkPassphrase: StellarSdk.Networks.TESTNET
                    })
                        .addOperation(StellarSdk.Operation.payment({
                            destination: '@Model.StellarAddress',
                            asset: StellarSdk.Asset.native(),
                            amount: $('#amount').val()
                        }))
                        .setTimeout(0)
                        .build()

                    transaction.sign(keypair)
                    return this.server.submitTransaction(transaction)
                })
                .then((res) => {
                    alert('Your donation was received successfully. Thanks!!')
                    location.reload();
                })
        } catch (err) {
            alert('There is an error with your donation: '+err)
        }
        finally {

        }
    }
</script>

<h2>@Model.Name</h2>

<div class="row">
    <div class="col-lg-6 col-md-6 col-sm-6">
        <img src="@Model.Photo" alt="@Model.Name" style="height:250px;" class="img-rounded img-responsive" />
    </div>
    <div class="col-lg-6 col-md-6 col-sm-6 alert alert-success">
        Website URL: <a href="@Model.Website" target="_blank">@Model.Website</a> <br />
        Created At: @Model.CreatedAt <br />
        Goal: @Model.FundGoal XLM<br />
        Balance: <span id="balance"></span> XLM <br />
        Deadline: <b>@Model.Deadline</b> <br />
        Stellar Address: @Model.StellarAddress
    </div>
</div>
<h3>Description</h3>

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 text-justify">
        @Model.Description
    </div>
</div>
<h3>Donate</h3>

<div class="row">
    <div class="col-lg-4 col-md-4 col-sm-4 text-justify">
        XLM amount: <br />
        <input type="number" min="0" name="amount" id="amount" class="form-control" />
    </div>
    <div class="col-lg-4 col-md-4 col-sm-4 text-justify">
        Your secret key: <br />
        <input type="text" name="secret" id="secret" class="form-control" />
    </div>
    <div class="col-lg-4 col-md-4 col-sm-4 text-justify">
        <br />
        <a href="#" onclick="donate()" class="btn btn-success">Donate</a>
    </div>
</div>


